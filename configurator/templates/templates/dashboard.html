<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard - {{ tenant_name or app_company_name }}</title>
  <link rel="stylesheet" href="{{ url_for('theme_css.theme_css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body class="tenant-{{ current_tenant or 'default' }}">
  <header class="topbar">
    <div class="brand">
      {% if tenant_logo %}
        <img src="{{ url_for('static', filename=tenant_logo.replace('static/','')) }}" alt="{{ tenant_name }}">
      {% endif %}
      <span>{{ tenant_name or app_company_name }}</span>
    </div>
    <nav>
      {% if enabled_modules.dashboard %}<a href="{{ url_for('dashboard.home') }}" class="active">Dashboard</a>{% endif %}
      {% if enabled_modules.produtos and session.get('usuario') == 'Gizele' %}<a href="{{ url_for('produtos.lista') }}">Produtos</a>{% endif %}
      {% if enabled_modules.vendas %}<a href="{{ url_for('vendas.vendas') }}">Vender</a>{% endif %}
      {% if enabled_modules.financeiro and session.get('usuario') == 'Gizele' %}<a href="{{ url_for('financeiro.home') }}">Financeiro</a>{% endif %}
      {% if enabled_modules.crediario and session.get('usuario') == 'Gizele' %}<a href="{{ url_for('crediario.index') }}">Crediário</a>{% endif %}
      {% if enabled_modules.etiquetas %}<a href="{{ url_for('etiquetas.home') }}">Etiquetas</a>{% endif %}
      {% if enabled_modules.config and session.get('usuario') == 'Gizele' %}<a href="{{ url_for('config.index') }}">Configurações</a>{% endif %}
      {% if enabled_modules.registro_vendas %}<a href="{{ url_for('registro_vendas.index') }}">Registro</a>{% endif %}
      <a href="{{ url_for('select_tenant.select') }}">Selecionar</a>
      <a href="{{ url_for('auth.logout') }}">Sair</a>
    </nav>
  </header>

  {% if session.get('setup_mode') %}
    <div class="card" style="margin-bottom:14px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;">
      <div style="font-weight:800">Modo de teste do Setup</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <a class="btn" href="{{ url_for('setup.home', step=3) }}">Voltar às edições</a>
        <form method="post" action="{{ url_for('setup.export_final') }}" style="margin:0">
          <button class="btn" type="submit" style="background:var(--accent);border-color:color-mix(in srgb, var(--accent) 40%, var(--border));color:#111;">Baixar app final (ZIP)</button>
        </form>
      </div>
    </div>
  {% endif %}

  {% set is_admin = (session.get('usuario') == 'Gizele') %}

  <main class="container">
    <h1>Dashboard <small>({{ tenant|capitalize }})</small></h1>

    {# ===========================================================
       AVISOS DE FATURA / LICENÇA
       Agora baseados nos flags do license_status()
       - show_expiry_warning/days_left: antes do dia 15
       - show_overdue/overdue_days/in_grace: após dia 15
       - license_require_code: pós-carência (dia 20+) -> login exige senha
       =========================================================== #}

    {% if show_expiry_warning %}
      <div class="expiry-banner">
        <span class="icon" aria-hidden="true">
          <!-- alert-circle -->
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12" y2="16"></line>
          </svg>
        </span>

        <div class="banner-text">
          Faltam <strong>{{ days_left }}</strong> dia{{ '' if days_left == 1 else 's' }} para o pagamento da sua fatura.
          {% if license_period_start %}
            <span class="after-grace">
              Vencimento do ciclo: <strong>{{ license_period_start.strftime('%d/%m/%Y') }}</strong>
            </span>
          {% endif %}
        </div>
      </div>
    {% endif %}

    {% if show_overdue %}
      <div class="expiry-banner warn">
        <span class="icon" aria-hidden="true">
          <!-- alert-triangle -->
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12" y2="17"></line>
          </svg>
        </span>

        <div class="banner-text">
          Sua fatura está atrasada há <strong>{{ overdue_days }}</strong> dia{{ '' if overdue_days == 1 else 's' }}.
          Efetue o pagamento para evitar bloqueios do sistema.

          {% if in_grace %}
            <span class="after-grace">
              Você está na carência. A partir do dia 20 o sistema exigirá a senha do mês no login.
            </span>
          {% else %}
            <span class="after-grace">
              Carência encerrada — o login exigirá a senha do mês.
            </span>
          {% endif %}
        </div>
      </div>
    {% endif %}

    {# Se por algum motivo o guard deixou passar e a licença exigir senha agora,
       reforçamos com um aviso “danger” (não deve acontecer, mas é útil). #}
    {% if license_require_code %}
      <div class="expiry-banner danger">
        <span class="icon" aria-hidden="true">
          <!-- x-circle -->
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M15 9l-6 6M9 9l6 6"></path>
          </svg>
        </span>

        <div class="banner-text">
          Carência encerrada. Para continuar usando o sistema, é necessário liberar o ciclo com a senha do mês no login.
          {% if license_grace_end %}
            <span class="after-grace">
              Carência terminou em: <strong>{{ license_grace_end.strftime('%d/%m/%Y') }}</strong>
            </span>
          {% endif %}
        </div>
      </div>
    {% endif %}

    {# ===========================================================
       AVISO: CREDIÁRIO VENCENDO HOJE
       =========================================================== #}
    {% if is_admin and crediario_due_today and crediario_due_today > 0 %}
      <div class="expiry-banner">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2"></rect>
            <path d="M8 2v4M16 2v4M3 10h18"></path>
            <circle cx="9" cy="15" r="1"></circle>
            <circle cx="15" cy="15" r="1"></circle>
          </svg>
        </span>

        <div class="banner-text">
          {% if crediario_due_today == 1 %}
            Hoje há <strong>1 cliente</strong> com parcela para pagar no crediário.
          {% else %}
            Hoje há <strong>{{ crediario_due_today }} clientes</strong> com parcela para pagar no crediário.
          {% endif %}
          <a class="banner-link" href="{{ url_for('crediario.index') }}">Ver crediário</a>
        </div>
      </div>
    {% endif %}

    <div class="cards">
      {% if is_admin %}
      <div class="card highlight">
        <div class="card-title">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="5" width="18" height="14" rx="2"></rect>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
          Total Vendido
        </div>
        <div class="card-value">R$ {{ "%.2f"|format(total or 0) }}</div>
      </div>
      {% endif %}

      <div class="card">
        <div class="card-title">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 7l9-4 9 4-9 4-9-4z"></path>
            <path d="M3 7v10l9 4 9-4V7"></path>
            <path d="M12 11v10"></path>
          </svg>
          Produtos com pouco estoque
        </div>
        <div class="card-action"><a href="{{ low_stock_link }}">Ver lista</a></div>
      </div>

      {% if is_admin %}
      <div class="card">
        <div class="card-title">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="16" rx="2"></rect>
            <path d="M3 10h18"></path>
            <path d="M9 14h2m3 0h2"></path>
          </svg>
          Estoque de produtos
        </div>
        <div class="card-action"><a href="{{ url_for('produtos.lista') }}">Abrir estoque</a></div>
      </div>
      {% endif %}

      {% if is_admin %}
      <div class="card">
        <div class="card-title">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 19V9"></path>
            <path d="M9 19V5"></path>
            <path d="M14 19v-7"></path>
            <path d="M19 19V3"></path>
          </svg>
          Relatórios
        </div>
        <div class="card-action"><a href="{{ url_for('financeiro.home') }}">Abrir</a></div>
      </div>
      {% endif %}

      {% if is_admin %}
      <div class="card">
        <div class="card-title">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="8" cy="8" r="3"></circle>
            <path d="M4 20c0-2.2 2.4-4 4-4s4 1.8 4 4"></path>
            <rect x="14" y="11" width="7" height="5" rx="1"></rect>
            <circle cx="17.5" cy="13.5" r="0.8"></circle>
          </svg>
          Crediário
        </div>
        <div class="card-action"><a href="{{ url_for('crediario.index') }}">Abrir</a></div>
      </div>
      {% endif %}

      <div class="card">
        <div class="card-title">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="19" cy="21" r="1"></circle>
            <path d="M3 4h2l2 12h12l2-8H8"></path>
          </svg>
          Fazer venda
        </div>
        <div class="card-action"><a href="{{ url_for('vendas.vendas') }}">Iniciar</a></div>
      </div>

      <div class="card">
        <div class="card-title">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 8l-4 4 4 4"></path>
            <path d="M16 12H8"></path>
          </svg>
          Voltar para Seleção
        </div>
        <div class="card-action"><a href="{{ url_for('select_tenant.select') }}">Voltar</a></div>
      </div>

      {% if is_admin %}
      <div class="card">
        <div class="card-title">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06A1.65 1.65 0 0 0 15 19.4a1.65 1.65 0 0 0-1 0l-.36.16a1.65 1.65 0 0 0-1 .36l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82"></path>
            <path d="M4.6 9a1.65 1.65 0 0 1-.33-1.82l.06-.06A2 2 0 1 0 1.5 4.29l-.06.06A1.65 1.65 0 0 0 1.1 6.17"></path>
          </svg>
          Configurações
        </div>
        <div class="card-action"><a href="{{ url_for('config.index') }}">Configurar</a></div>
      </div>
      {% endif %}
    </div>
  </main>

  <footer class="footer">
    <small>© 2025 - Sistema Custom Mind</small>
  </footer>
</body>
</html>
